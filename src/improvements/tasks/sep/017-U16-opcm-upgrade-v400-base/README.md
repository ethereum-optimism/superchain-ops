# 017-U16-opcm-upgrade-v400-base: Upgrade 16: Base Sepolia

Status: [DRAFT]()

## Objective

Executes Upgrade 16 on Base Sepolia.

This task uses `op-contract/v4.0.0` [OPContractsManager](https://github.com/ethereum-optimism/optimism/blob/op-contracts/v4.0.0-rc.3/packages/contracts-bedrock/src/L1/OPContractsManager.sol) to upgrade the following chains:

1. Base Sepolia

### Timing

Expected to be executed on or around 2025-05-29.

## Transaction creation

The transaction is generated by the [OPCMUpgradeV400 template script](../../../template/OPCMUpgradeV400.sol),
which reads the inputs from the [`config.toml`](./config.toml) file.

## Signing and execution

Signing and execution instructions for this task are unique because of the extra layer of nesting.
The L1 ProxyAdmin Owner (L1PAO) is setup as following for Base Sepolia:

```mermaid
graph TD
  subgraph Signers
    Signer1[Signer1]
    Signer2[Signer2]
    Signer3[Signer3]
    Signer4[Signer4]
    Signer5[Signer5]
    Signer6[Signer6]
  end

  Signer1 --> Base
  Signer2 --> Base
  Signer3 --> SC
  Signer4 --> SC
  Signer5 --> FND
  Signer6 --> FND

  Base --> BaseNested --> L1PAO
  SC --> BaseNested
  FND --> L1PAO
  L1PAO --> ProxyAdmin
 ```

where:

- L1PAO is `0x0fe884546476dDd290eC46318785046ef68a0BA9`
- FND is `0x6AF0674791925f767060Dd52f7fB20984E8639d8`
- BaseNested is `0x646132A1667ca7aD00d36616AFBA1A28116C770A`
- Base is `0x6AF0674791925f767060Dd52f7fB20984E8639d8` (on Sepolia, the Base and FND safes are the same)
- SC is `0x5dfEB066334B67355A15dc9b67317fD2a2e1f77f`
- `SignerN` represent arbitrary signers for Safes

### Facilitator Instructions

The facilitator, or someone acting on behalf of the facilitator, must perform the following steps:

1. Simulate this task from the `BaseNested` 2/2 by running `just simulate-stack sep 017-U16-opcm-upgrade-v400-base "[0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000,0x646132A1667ca7aD00d36616AFBA1A28116C770A]"`
2. In the terminal logs, search for `017-U16-opcm-upgrade-v400-base` to find where the logs for this task begin. Directly above the Domain Hash and Message Hash, the Safe Transaction Hash will be logged. See the [Simulation](#simulation) section for more details on how to do this step.
3. Run `just new task` and select the `GnosisSafeApproveHash` option to create a new task, and update the config file so this Safe Transaction Hash is used. Your config file should contain this:

    ```toml
    safeAddressString = "BaseNestedSafe"
    safeTxHash = "<safe-transaction-hash>"
    ```

4. Edit the numbers in the task directories such that the approve hash is prefixed with `XXX-1-*` and the primary task is `XXX-2-*`, where `XXX` is the task number such as `017`. For example, if this task folder was originally named `017-U16-opcm-upgrade-v400-base`, rename it to `017-2-U16-opcm-upgrade-v400-base` and the new `GnosisSafeApproveHash` folder name is `017-1-U16-opcm-upgrade-v400-base-approveHash`.
5. This new task will be a nested task, so signers can sign with `just --dotenv-path $(pwd)/.env --justfile ../../../nested.just sign <base-council|base-operations>`

Now, wait for the Base and Security Council signers to complete [their steps](#base-and-security-council-signer-instructions).
Once you received signatures from Base and Security Council signers:

1. In the separate safe transaction approval hash task, run the approvals and execution. This will approve their nested hash on the `BaseNested` 2/2.
2. Now, run the standard foundation approvals in this task. (This step may be swapped with the prior step if desired).
3. At this point, this task may be executed.

### Foundation Signer Instructions

If you are a foundation signer, you will sign as normal. Follow the instructions in the
[Nested Execution](../../../NESTED.md) guide for the following steps:

- [1. Update repo](../../../NESTED.md#1-update-repo)
- [2. Setup Ledger](../../../NESTED.md#2-setup-ledger)
- [3. Simulate and validate the transaction](../../../NESTED.md#3-simulate-and-validate-the-transaction)

Then follow the instructions in the [Validation](./VALIDATION.md) guide.

### Base and Security Council Signer Instructions

If you are a base or security council signer, you will actually sign in this task directory: TODO.

Your ceremony facilitator will have performed the first three steps listed in the [Facilitator Instructions](#facilitator-instructions) section.

Once that is done, your instructions as a signer are as follows:

1. In this directory, run the simulation as described in the [Simulation](#simulation) section and save off the Safe Transaction Hash. Perform the validation for this task as normal.
2. Navigate to your GnosisSafeApproveHash task's directory, and follow the instructions to sign and validate that approval hash as normal.
3. When performing the validation step, additionally ensure the data you are signing should match the Safe Transaction Hash you saved off in step 1.
4. Send the signature to your ceremony facilitator.

## Simulation

Simulate the stack of queued tasks for this network by running:

```sh
cd src/improvements
just simulate-stack sep 017-U16-opcm-upgrade-v400-base "[0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000,0x646132A1667ca7aD00d36616AFBA1A28116C770A]"
```

In the simulation logs, search for the string `017-U16-opcm-upgrade-v400-base` to find the logs
for this task's output. You will see the Safe Transaction Hash logged to a line beginning with
`Safe Transaction Hash:`. That is the hash signers on the Base or Security Council safes will approve.
