// SPDX-License-Identifier: MIT
pragma solidity 0.8.15;

import {Test} from "forge-std/Test.sol";
import {IGnosisSafe} from "@base-contracts/script/universal/IGnosisSafe.sol";
import {Solarray} from "lib/optimism/packages/contracts-bedrock/scripts/libraries/Solarray.sol";

import {MultisigTask} from "src/improvements/tasks/MultisigTask.sol";
import {GasConfigTemplate} from "test/tasks/mock/template/GasConfigTemplate.sol";
import {EnableDeputyPauseModuleTemplate} from "src/improvements/template/EnableDeputyPauseModuleTemplate.sol";
import {FinanceTemplate} from "src/improvements/template/FinanceTemplate.sol";
import {OPCMUpgradeV200} from "src/improvements/template/OPCMUpgradeV200.sol";
import {OPCMUpgradeV300} from "src/improvements/template/OPCMUpgradeV300.sol";
import {OPCMUpgradeV400} from "src/improvements/template/OPCMUpgradeV400.sol";
import {OPCMUpdatePrestateV300} from "src/improvements/template/OPCMUpdatePrestateV300.sol";
import {SetRespectedGameTypeTemplate} from "src/improvements/template/SetRespectedGameTypeTemplate.sol";
import {UpdateRetirementTimestampV200} from "src/improvements/template/UpdateRetirementTimestampV200.sol";
import {UpdateRetirementTimestampV400} from "src/improvements/template/UpdateRetirementTimestampV400.sol";
import {SystemConfigGasParams} from "src/improvements/template/SystemConfigGasParams.sol";
import {MultisigTaskTestHelper} from "test/tasks/MultisigTask.t.sol";
import {DelayedWETHOwnershipTemplate} from "src/improvements/template/DelayedWETHOwnershipTemplate.sol";
import {TransferOwners} from "src/improvements/template/TransferOwners.sol";
import {TransferL2PAOFromL1} from "src/improvements/template/TransferL2PAOFromL1.sol";
import {DisableModule} from "src/improvements/template/DisableModule.sol";
import {Action} from "src/libraries/MultisigTypes.sol";
import {GnosisSafeApproveHash} from "src/improvements/template/GnosisSafeApproveHash.sol";
import {SetDisputeGameImpl} from "src/improvements/template/SetDisputeGameImpl.sol";
import {GnosisSafeHashes} from "src/libraries/GnosisSafeHashes.sol";
import {WelcomeToSuperchainOps} from "src/improvements/template/WelcomeToSuperchainOps.sol";
import {GnosisSafeRemoveOwner} from "src/improvements/template/GnosisSafeRemoveOwner.sol";
import {SetEIP1967Implementation} from "src/improvements/template/SetEIP1967Implementation.sol";
import {UnpauseSuperchainConfigV400} from "src/improvements/template/UnpauseSuperchainConfigV400.sol";
import {UniFix} from "src/improvements/template/UniFix.sol";
import {DeputyPauseKeyRotationTemplate} from "src/improvements/template/DeputyPauseKeyRotationTemplate.sol";
import {BlacklistGamesV140} from "src/improvements/template/BlacklistGamesV140.sol";
import {BlacklistGamesV400} from "src/improvements/template/BlacklistGamesV400.sol";
import {OPCMUpgradeV220toV400} from "src/improvements/template/OPCMUpgradeV220toV400.sol";
import {EnableLivenessModule2} from "src/improvements/template/EnableLivenessModule2.sol";
import {DisableLivenessModule2} from "src/improvements/template/DisableLivenessModule2.sol";
import {TransitionToLivenessModule2} from "src/improvements/template/TransitionToLivenessModule2.sol";

/// @notice Ensures that simulating the task consistently produces the same call data and data to sign.
/// This guarantees determinism if a bug is introduced in the task logic, the call data or data to sign
/// would differ for the same block, causing these tests to fail.
contract RegressionTest is Test {
    /// @notice expected call data and data to sign generated by manually running the GasConfigTemplate at block 21724199 on mainnet using script:
    /// forge script test/template/GasConfigTemplate.sol --sig "simulate(string)" test/tasks/mock/configs/SingleMultisigGasConfigTemplate.toml --rpc-url mainnet --fork-block-number 21724199 -vv
    function testRegressionCallDataMatches_SingleMultisigGasConfigTemplate() public {
        address rootSafe = address(0x4a4962275DF8C60a80d3a25faEc5AA7De116A746); // SystemConfigOwner
        string memory taskConfigFilePath = "test/tasks/mock/configs/SingleMultisigGasConfigTemplate.toml";
        // Calldata generated by manually running the gas config template at block 21724199 on mainnet.
        string memory expectedCallData =
            "0x174dea7100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000005e6432f18bc5d497b1ab2288a025fbf9d69e22210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024b40a817c0000000000000000000000000000000000000000000000000000000005f5e100000000000000000000000000000000000000000000000000000000000000000000000000000000007bd909970b0eedcf078de6aeff23ce571663b8aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024b40a817c0000000000000000000000000000000000000000000000000000000005f5e10000000000000000000000000000000000000000000000000000000000";

        MultisigTask multisigTask = new GasConfigTemplate();

        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 21724199, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // Data to sign generated by manually running the gas config template at block 21724199 on mainnet.
        string memory expectedDataToSign =
            "0x19010f634ad56005ddbd68dc52233931a858f740b8ab706671c42b055efef561257e5ba28ec1e58ea69211eb8e875f10ae165fb3fb4052b15ca2516486f4b059135f";
        string memory dataToSign = vm.toString(
            GnosisSafeHashes.getEncodedTransactionData(rootSafe, rootSafeCalldata, 0, rootSafeNonce, MULTICALL3_ADDRESS)
        );
        // assert that the data to sign generated in simulate is the same as the expected data to sign
        assertEq(keccak256(bytes(dataToSign)), keccak256(bytes(expectedDataToSign)));
        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice expected call data and data to sign generated by manually running the GasConfigTemplate at block 21724199 on mainnet using script:
    /// forge script test/template/GasConfigTemplate.sol --sig "simulate(string)" test/tasks/mock/configs/OPMainnetGasConfigTemplate.toml --rpc-url mainnet --fork-block-number 21724199 -vv
    function testRegressionCallDataMatches_OPMainnetGasConfigTemplate() public {
        string memory taskConfigFilePath = "test/tasks/mock/configs/OPMainnetGasConfigTemplate.toml";
        // call data generated by manually running the gas config template at block 21724199 on mainnet
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000229047fed2591dbec1ef1118d64f7af3db9eb2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024b40a817c000000000000000000000000000000000000000000000000000000000393870000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new GasConfigTemplate();
        address rootSafe = address(0x847B5c174615B1B7fDF770882256e2D3E95b9D92); // SystemConfigOwner
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 21724199, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // data to sign generated by manually running the gas config template at block 21724199 on mainnet
        string memory expectedDataToSign =
            "0x1901a4a9c312badf3fcaa05eafe5dc9bee8bd9316c78ee8b0bebe3115bb21b732672c98bc9c1761f2e403be0ad32b16d9c5fedf228f97eb0420c722b511129ebc803";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice expected call data and data to sign generated by manually running the SetRespectedGameTypeTemplate at block 21724199 on mainnet using script:
    /// forge script src/improvements/template/SetRespectedGameTypeTemplate.sol --sig "simulate(string)" test/tasks/mock/configs/SetRespectedGameTypeTemplate.toml --rpc-url mainnet --fork-block-number 21724199 -vv
    function testRegressionCallDataMatches_SetRespectedGameTypeTemplate() public {
        string memory taskConfigFilePath = "test/tasks/mock/configs/SetRespectedGameTypeTemplate.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c6901f65369fc59fc1b4d6d6be7a2318ff38db5b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044a1155ed9000000000000000000000000beb5fc579115071764c7423a4f12edde41f106ed000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new SetRespectedGameTypeTemplate();
        address rootSafe = address(0x9BA6e03D8B90dE867373Db8cF1A58d2F7F006b3A); // FoundationOperationSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 21724199, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        string memory expectedDataToSign =
            "0x19014e6a6554de0308f5ece8ff736beed8a1b876d16f5c27cac8e466d7de0c7038904a8d9abb28e3fbba3ffc928e3357077c716885b5b1e2c51f2ee976a24f02445d";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice expected call data and data to sign generated by manually running the example task test/tasks/example/sep/020-blacklist-games-v140:
    /// cd test/tasks/example/sep/020-blacklist-games-v140
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate council
    function testRegressionCallDataMatches_BlacklistGamesV140() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/020-blacklist-games-v140/config.toml";
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000ff6eba109271fe6d4237eeed4bab1dd9a77dd1a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000247d6be8dc00000000000000000000000078f0d900f1cd8fa4d60227ffead39d48f173a50500000000000000000000000000000000000000000000000000000000000000000000000000000000ff6eba109271fe6d4237eeed4bab1dd9a77dd1a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000247d6be8dc0000000000000000000000002c0df6439425cf3ef5e7482a22caa8c4648024d700000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new BlacklistGamesV140();
        address rootSafe = address(0x7a50f00e8D05b95F98fE38d8BeE366a7324dCf7E); // GuardianSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9012773, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        string[] memory expectedDataToSign = new string[](1);
        expectedDataToSign[0] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533c8fdcc1b217b04c31388ed0840379310995cf02a324ef3972cf356a69ce43d1d";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice expected call data and data to sign generated by manually running the example task test/tasks/example/sep/021-blacklist-games-v400:
    /// cd test/tasks/example/sep/021-blacklist-games-v400
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate council
    function testRegressionCallDataMatches_BlacklistGamesV400() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/021-blacklist-games-v400/config.toml";
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000a1cec548926eb5d69aa3b7b57d371edbdd03e64b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000247d6be8dc000000000000000000000000b723b7a3e95d10c5bb997be18cffcd48c90ecb6800000000000000000000000000000000000000000000000000000000000000000000000000000000a1cec548926eb5d69aa3b7b57d371edbdd03e64b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000247d6be8dc0000000000000000000000004ef511afa4d8e3ebae1e9ee4a97d51f8c79f481300000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new BlacklistGamesV400();
        address rootSafe = address(0x7a50f00e8D05b95F98fE38d8BeE366a7324dCf7E); // GuardianSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9020234, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        string[] memory expectedDataToSign = new string[](1);
        expectedDataToSign[0] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b85332b1cdfb86d9f2f7e657e8a83ee84b1dc9648a35500de5f2dd57c1629a5dfac9e";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice expected call data and data to sign generated by manually running the UpdateRetirementTimestampV200 at block 22183268 on mainnet using script:
    /// forge script src/improvements/template/UpdateRetirementTimestampV200.sol --sig "simulate(string)" test/tasks/mock/configs/UpdateRetirementTimestampV200.toml --rpc-url mainnet --fork-block-number 22183268 -vv
    function testRegressionCallDataMatches_UpdateRetirementTimestampV200() public {
        string memory taskConfigFilePath = "test/tasks/mock/configs/UpdateRetirementTimestampV200.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c6901f65369fc59fc1b4d6d6be7a2318ff38db5b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044a1155ed9000000000000000000000000beb5fc579115071764c7423a4f12edde41f106ed00000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new UpdateRetirementTimestampV200();
        address rootSafe = address(0x9BA6e03D8B90dE867373Db8cF1A58d2F7F006b3A); // FoundationOperationSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 22183268, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        string memory expectedDataToSign =
            "0x19014e6a6554de0308f5ece8ff736beed8a1b876d16f5c27cac8e466d7de0c703890efd5a0cf1fefc641f8d16675981b0640aaba135e5d798cf4a14ad442d3022b86";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice expected call data and data to sign generated by manually running the example task test/tasks/example/sep/022-update-retirement-timestamp-v400:
    /// cd test/tasks/example/sep/022-update-retirement-timestamp-v400
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate council
    function testRegressionCallDataMatches_UpdateRetirementTimestampV400() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/022-update-retirement-timestamp-v400/config.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000a1cec548926eb5d69aa3b7b57d371edbdd03e64b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000004d5a3e12e00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new UpdateRetirementTimestampV400();
        address rootSafe = address(0x7a50f00e8D05b95F98fE38d8BeE366a7324dCf7E); // GuardianSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9020234, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        string[] memory expectedDataToSign = new string[](1);
        expectedDataToSign[0] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b85337a9149cf89f7f968d83010b63fe03a3f3946ff40e51fe9f2d3980817d3222c5d";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice expected call data and data to sign generated by manually running the EnableDeputyPauseModuleTemplate at block 7745524 on sepolia using script:
    /// forge script src/improvements/template/EnableDeputyPauseModuleTemplate.sol --sig "simulate(string)" test/tasks/mock/configs/EnableDeputyPauseModuleTemplate.toml --rpc-url sepolia --fork-block-number 7745524 -vv
    function testRegressionCallDataMatches_EnableDeputyPauseModuleTemplate() public {
        string memory taskConfigFilePath = "test/tasks/mock/configs/EnableDeputyPauseModuleTemplate.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000837de453ad5f21e89771e3c06239d8236c0efd5e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024610b592500000000000000000000000062f3972c56733ab078f0764d2414dfcaa99d574c00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new EnableDeputyPauseModuleTemplate();
        address rootSafe = address(0x837DE453AD5F21E89771e3c06239d8236c0EFd5E);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 7745524, "sepolia", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        string memory expectedDataToSign =
            "0x1901e84ad8db37faa1651b140c17c70e4c48eaa47a635e0db097ddf4ce1cc14b9ecbf55e2ed894ddff4c0045537c8239db1c4b3ac5700049164b5823ecaa045d7334";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Expected call data and data to sign generated by manually running the OPCMUpgradeV200 template at block 7757671 on sepolia using script:
    /// forge script OPCMUpgradeV200 --sig "simulate(string)" test/tasks/example/sep/002-opcm-upgrade-v200/config.toml --rpc-url sepolia --fork-block-number 7826712 -vv
    function testRegressionCallDataMatches_OPCMUpgradeV200() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/002-opcm-upgrade-v200/config.toml";
        // Call data generated by manually running the OPCMUpgradeV200 template at block 7826712 on sepolia
        string memory expectedCallData =
            "0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000001b25f566336f47bc5e0036d66e142237dcf4640b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4ff2dd5a100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000034edd2a225f7f429a63e0f1d2084b9e0a93b538000000000000000000000000189abaaaa82dfc015a588a7dbad6f13b1d3485bc035ac388b5cb22acf52a2063cfde108d09b1888655d21f02f595f9c3ea6cbdcd00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new OPCMUpgradeV200();
        address rootSafe = address(0x1Eb2fFc903729a0F03966B917003800b145F56E2);
        address foundationChildMultisig = 0xDEe57160aAfCF04c34C887B5962D0a69676d3C8B; // sepolia
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, foundationChildMultisig);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 7826712, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the OPCMUpgradeV200 template at block 7826712 on sepolia
        // for each child multisig
        string[] memory expectedDataToSign = new string[](2);
        expectedDataToSign[0] =
            "0x190137e1f5dd3b92a004a23589b741196c8a214629d4ea3a690ec8e41ae45c689cbbc4308e7f6e5e57b1527f2a53444553ecad29ae331fa07bbc0c91e6e73986e250";
        expectedDataToSign[1] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533efa681cff20329f64ecd2a4ec88d618f5e3aaee370a9a4550df3cda85e94352e";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the OPCMUpgradeV300 template at block 8044263 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/006-opcm-upgrade-v300) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <foundation|council>
    function testRegressionCallDataMatches_OPCMUpgradeV300() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/006-opcm-upgrade-v300/config.toml";
        // Call data generated by manually running the OPCMUpgradeV300 template at block 7972618 on sepolia
        string memory expectedCallData =
            "0x82ad56cb000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000fbceed4de885645fbded164910e10f52febfab350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4ff2dd5a100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000034edd2a225f7f429a63e0f1d2084b9e0a93b538000000000000000000000000189abaaaa82dfc015a588a7dbad6f13b1d3485bc03ee2917da962ec266b091f4b62121dc9682bb0db534633707325339f99ee40500000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new OPCMUpgradeV300();
        address rootSafe = address(0x1Eb2fFc903729a0F03966B917003800b145F56E2);
        address foundationChildMultisig = 0xDEe57160aAfCF04c34C887B5962D0a69676d3C8B; // sepolia
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, foundationChildMultisig);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8044263, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the OPCMUpgradeV300 template at block 8044263 on sepolia for each child multisig.
        string[] memory expectedDataToSign = new string[](2);
        // Foundation data to sign
        expectedDataToSign[0] =
            "0x190137e1f5dd3b92a004a23589b741196c8a214629d4ea3a690ec8e41ae45c689cbb11f6f1f3f232ad28d30230fa28696a442aa331937c8555e31c226b8bf3113539";
        // Security council data to sign
        expectedDataToSign[1] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533e69a8eedc212201257878d96005085a48167c2dd1a817fec01be553c995f5ca4";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the OPCMUpgradeV400 template at block 8368038 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/008-opcm-upgrade-v400) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <foundation|council>
    function testRegressionCallDataMatches_OPCMUpgradeV400() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/008-opcm-upgrade-v400/config.toml";
        // Call data generated by manually running the OPCMUpgradeV400 template at block 8318585 on sepolia
        string memory expectedCallData =
            "0x82ad56cb00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000044c191ce5ce35131e703532af75fa9ca221e23980000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4ff2dd5a100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000034edd2a225f7f429a63e0f1d2084b9e0a93b538000000000000000000000000189abaaaa82dfc015a588a7dbad6f13b1d3485bc03eb07101fbdeaf3f04d9fb76526362c1eea2824e4c6e970bdb19675b72e4fc800000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new OPCMUpgradeV400();
        address rootSafe = address(0x1Eb2fFc903729a0F03966B917003800b145F56E2);
        address foundationChildMultisig = 0xDEe57160aAfCF04c34C887B5962D0a69676d3C8B; // sepolia
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, foundationChildMultisig);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8469737, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the OPCMUpgradeV400 template at block 8318585 on sepolia
        // for each child multisig.
        string[] memory expectedDataToSign = new string[](2);
        // Foundation data to sign
        expectedDataToSign[0] =
            "0x190137e1f5dd3b92a004a23589b741196c8a214629d4ea3a690ec8e41ae45c689cbb87ee50a37f48a4e4bb87ccbfd4ecaa93fa2d6b160ed09514c341d37808a53ad1";
        // Security council data to sign
        expectedDataToSign[1] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b853387e1c03a81ed868bb85caef0bc0ce050a1c900d8003e4026e21a55f93b0ab58d";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the SystemConfigGasParams template at block 22283936 on mainnet.
    /// Simulate from task directory (test/tasks/example/eth/006-system-config-gas-params) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate
    function testRegressionCallDataMatches_SystemConfigGasParams() public {
        string memory taskConfigFilePath = "test/tasks/example/eth/006-system-config-gas-params/config.toml";
        // Call data generated by manually running the SystemConfigGasParams template at block 22283936 on mainnet
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000229047fed2591dbec1ef1118d64f7af3db9eb2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024b40a817c0000000000000000000000000000000000000000000000000000000002625a0000000000000000000000000000000000000000000000000000000000000000000000000000000000229047fed2591dbec1ef1118d64f7af3db9eb2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044c0fd4b4100000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new SystemConfigGasParams();
        address rootSafe = address(0x847B5c174615B1B7fDF770882256e2D3E95b9D92); // FoundationUpgradeSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 22283936, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // data to sign generated by manually running the FinanceTemplate at block 7880546 on sepolia
        string memory expectedDataToSign =
            "0x1901a4a9c312badf3fcaa05eafe5dc9bee8bd9316c78ee8b0bebe3115bb21b73267249771935e440b6212f2f0a8302967dcac81b52ea7573563fd25b9b7ee33d8b3e";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice expected call data and data to sign generated by manually running the DelayedWETHOwnershipTemplate at block 22183268 on mainnet using script:
    /// forge script src/improvements/template/DelayedWETHOwnershipTemplate.sol --sig "simulate(string)" test/tasks/example/eth/007-delayedweth-xfer/config.toml --rpc-url mainnet --fork-block-number 22183268 -vv
    function testRegressionCallDataMatches_DelayedWETHOwnershipTemplate() public {
        string memory taskConfigFilePath = "test/tasks/example/eth/007-delayedweth-xfer/config.toml";
        // call data generated by manually running the DelayedWETHOwnershipTemplate at block 22183268 on mainnet
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000323dfc63c9b83cb83f40325aab74b245937cbdf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024f2fde38b0000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a0000000000000000000000000000000000000000000000000000000000000000000000000000000021429af66058bc3e4ae4a8f2ec4531aac433ecbc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024f2fde38b0000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new DelayedWETHOwnershipTemplate();
        address rootSafe = address(0x9BA6e03D8B90dE867373Db8cF1A58d2F7F006b3A);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 22183268, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // data to sign generated by manually running the DelayedWETHOwnershipTemplate at block 22183268 on mainnet
        string memory expectedDataToSign =
            "0x19014e6a6554de0308f5ece8ff736beed8a1b876d16f5c27cac8e466d7de0c7038908e5dea9945db51a2fd31cc5fa5b253f41b5a48a277d5c22c494851aa42567e8a";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice expected call data and data to sign generated by manually running the FinanceTemplate at block 7880546 on sepolia using script:
    /// forge script src/improvements/template/FinanceTemplate.sol --sig "simulate(string)" test/tasks/mock/configs/TestFinanceTemplate.toml --rpc-url sepolia --fork-block-number 7880546 -vv
    function testRegressionCallDataMatches_FinanceTemplate() public {
        string memory taskConfigFilePath = "test/tasks/mock/configs/TestFinanceTemplate.toml";
        // call data generated by manually running the FinanceTemplate at block 7880546 on sepolia
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000140000000000000000000000000bb4daac11b4446ee1c6146de1e26ecf1ab8b3eb60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000f64bc17485f0b4ea5f06a96514182fc4cb5619770000000000000000000000000000000000000000000000056bc75e2d6310000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb4daac11b4446ee1c6146de1e26ecf1ab8b3eb60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044095ea7b300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000056bc75e2d6310000000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new FinanceTemplate();
        address rootSafe = address(0xcBC62730b54BFE94173B1182FA56Db1393451d4e); // 'SafeToSendFrom' value in config.toml file.
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 7880546, "sepolia", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // data to sign generated by manually running the FinanceTemplate at block 7880546 on sepolia
        string memory expectedDataToSign =
            "0x190196c653b6193d04eb71ad87ac1577524661acf1e1e0c492a68c88a1deb059927f5c6e8f9c07df88078080944e37bdee8fabf7e4c4addbfb7c56281712bf386a4a";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Expected call data and data to sign generated by manually running the OPCMUpdatePrestateV300 template at block 8098229 on sepolia
    /// Simulate from task directory (test/tasks/example/sep/008-opcm-upgrade-prestate-v300) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <foundation|council>
    function testRegressionCallDataMatches_OPCMUpdatePrestateV300() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/008-opcm-upgrade-prestate-v300/config.toml";
        // Call data generated by manually running the OPCMUpdatePrestateV300 template at block 8098229 on sepolia.
        string memory expectedCallData =
            "0x82ad56cb000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000fbceed4de885645fbded164910e10f52febfab350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a49a72745b00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000034edd2a225f7f429a63e0f1d2084b9e0a93b538000000000000000000000000189abaaaa82dfc015a588a7dbad6f13b1d3485bc03682932cec7ce0a3874b19675a6bbc923054a7b321efc7d3835187b172494b600000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new OPCMUpdatePrestateV300();
        address rootSafe = address(0x1Eb2fFc903729a0F03966B917003800b145F56E2);
        address foundationChildMultisig = 0xDEe57160aAfCF04c34C887B5962D0a69676d3C8B;
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, foundationChildMultisig);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8098229, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the OPCMUpdatePrestateV300 template at block 8098229 on sepolia.
        string[] memory expectedDataToSign = new string[](2);
        // Foundation
        expectedDataToSign[0] =
            "0x190137e1f5dd3b92a004a23589b741196c8a214629d4ea3a690ec8e41ae45c689cbbb1f8d34235beb2352fb105844bbe0ddd2f2e940cbf9718fd1cd603f45dd490af";
        // Security council
        expectedDataToSign[1] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b853381e5ba64d901a287c73ec3c85d7fb1f2e6b629e2450583b6532b301ee6ee5347";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the TransferL2PAOFromL1 template at block 22447773 on mainnet.
    /// Simulate from task directory (test/tasks/example/eth/008-transfer-l2pao) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <foundation|council>
    function testRegressionCallDataMatches_TransferL2PAOFromL1() public {
        string memory taskConfigFilePath = "test/tasks/example/eth/008-transfer-l2pao/config.toml";
        // Call data generated by manually running the TransferL2PAOFromL1 template at block 22447773 on mainnet.
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000bd48f6b86a26d3a217d0fa6ffe2b491b956a7a20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000104e9e05c42000000000000000000000000420000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030d40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000024f2fde38b0000000000000000000000006b1bae59d09fccbddb6c6cceb07b7279367c4e3b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new TransferL2PAOFromL1();
        address currentRootSafe = address(0x6d5B183F538ABB8572F5cD17109c617b994D5833);
        address foundationChildMultisig = 0x847B5c174615B1B7fDF770882256e2D3E95b9D92;
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(currentRootSafe, foundationChildMultisig);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 22447773, "mainnet", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the TransferL2PAOFromL1 template at block 22447773 on mainnet.
        string[] memory expectedDataToSign = new string[](3);
        // Chain Governor
        expectedDataToSign[0] =
            "0x19014f0b6efb6c01fa7e127a0ff87beefbeb53e056d30d3216c5ac70371b909ca66dfb594dad0fab2218f67e5dfd7c87902748576e588a07d519f00bad25ed8bf8fa";
        // Foundation
        expectedDataToSign[1] =
            "0x1901a4a9c312badf3fcaa05eafe5dc9bee8bd9316c78ee8b0bebe3115bb21b732672fed866eb0ea2cb397e3221b69f5761605f7362acd36b63b250590620bf5afb9b";
        // Security council
        expectedDataToSign[2] =
            "0x1901df53d510b56e539b90b369ef08fce3631020fbf921e3136ea5f8747c20bce9673ab916bc61b8c632aec6f0c75fb0ad2514dcda3bd2fb7030465b7e02fb7f8764";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, currentRootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the DisableModule template at block 8326814 on sepolia
    /// Simulate from task directory (test/tasks/example/sep/011-disable-module) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate
    function testRegressionCallDataMatches_DisableModule() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/011-disable-module/config.toml";
        // Call data generated by manually running the DisableModule template at block 8326814 on sepolia.
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000007a50f00e8d05b95f98fe38d8bee366a7324dcf7e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044e009cfde0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000fd7e6ef1f6c9e4cc34f54065bf8496ce41a4e2e800000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new DisableModule();
        address rootSafe = address(0x7a50f00e8D05b95F98fE38d8BeE366a7324dCf7E);
        address nestedSafe = address(0xf64bc17485f0B4Ea5F06A96514182FC4cB561977);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, nestedSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8326814, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the DisableModule template at block 8326814 on sepolia.
        string[] memory expectedDataToSign = new string[](1);
        // Council
        expectedDataToSign[0] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b85339654f9ead3f00526f2118928a8d9c125a15e37c6ba8b92430dc207ac54928c2f";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the UnpauseSuperchainConfigV400 template at block 8792870 on sepolia
    /// Simulate from task directory (test/tasks/example/sep/019-unpause-superchainConfig) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate council
    function testRegressionCallDataMatches_UnpauseSuperchainConfigV400() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/019-unpause-superchainConfig/config.toml";
        // Call data generated by manually running the UnpauseSuperchainConfigV400 template at block 8792870 on sepolia.
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002457b001f9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new UnpauseSuperchainConfigV400();
        address rootSafe = address(0x7a50f00e8D05b95F98fE38d8BeE366a7324dCf7E);
        address nestedSafe = address(0xf64bc17485f0B4Ea5F06A96514182FC4cB561977);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, nestedSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8792870, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the UnpauseSuperchainConfigV400 template at block 8792870 on sepolia.
        string[] memory expectedDataToSign = new string[](1);
        // Council
        expectedDataToSign[0] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533568ef7810386d4be5591ed8d616b84789847e5f27d993f4f40ce1540579c0abe";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the TransferOwners template at block 22469206 on mainnet.
    /// Simulate from task directory (test/tasks/example/eth/009-transfer-owners) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <foundation|council>
    function testRegressionCallDataMatches_TransferOwners() public {
        string memory taskConfigFilePath = "test/tasks/example/eth/009-transfer-owners/config.toml";
        // Call data generated by manually running the TransferOwners template at block 22469206 on mainnet.
        string memory expectedCallData =
            "0x174dea7100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000004e000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000007e00000000000000000000000002f12d621a16e2d3285929c9996f478508951dfe40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024f2fde38b0000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a000000000000000000000000000000000000000000000000000000000000000000000000000000003b73fa8d82f511a3cae17b5a26e4e1a2d5e2f2a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec400000000000000000000000084b268a4101a8c8e3ccb33004f81ed08202ba124000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc0000000000000000000000000000000000000000000000000000000000000000000000000000000084b268a4101a8c8e3ccb33004f81ed08202ba12400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db0800000000000000000000000000000000000000000000000000000000000000330000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a000000000000000000000000000000000000000000000000000000000000000000000000000000003b73fa8d82f511a3cae17b5a26e4e1a2d5e2f2a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec400000000000000000000000084b268a4101a8c8e3ccb33004f81ed08202ba1240000000000000000000000005e40b9231b86984b5150507046e354dbfbed3d9e000000000000000000000000000000000000000000000000000000000000000000000000000000003b73fa8d82f511a3cae17b5a26e4e1a2d5e2f2a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000c9edb4e340f4e9683b4557bd9db8f9d932177c86000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc00000000000000000000000000000000000000000000000000000000000000000000000000000000c9edb4e340f4e9683b4557bd9db8f9d932177c8600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db0800000000000000000000000000000000000000000000000000000000000000330000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a000000000000000000000000000000000000000000000000000000000000000000000000000000003b73fa8d82f511a3cae17b5a26e4e1a2d5e2f2a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000c9edb4e340f4e9683b4557bd9db8f9d932177c860000000000000000000000005e40b9231b86984b5150507046e354dbfbed3d9e000000000000000000000000000000000000000000000000000000000000000000000000000000003b73fa8d82f511a3cae17b5a26e4e1a2d5e2f2a40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024f2fde38b0000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new TransferOwners();
        address currentRootSafe = address(0x6d5B183F538ABB8572F5cD17109c617b994D5833);
        address foundationChildMultisig = 0x847B5c174615B1B7fDF770882256e2D3E95b9D92;
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(currentRootSafe, foundationChildMultisig);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 22469206, "mainnet", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the TransferOwners template at block 22469206 on mainnet.
        string[] memory expectedDataToSign = new string[](3);
        // Chain governor
        expectedDataToSign[0] =
            "0x19014f0b6efb6c01fa7e127a0ff87beefbeb53e056d30d3216c5ac70371b909ca66deb125b2251625aa3f98d8d46c8d8771105d0475cdda3c35de7672d4945b54498";
        // Foundation
        expectedDataToSign[1] =
            "0x1901a4a9c312badf3fcaa05eafe5dc9bee8bd9316c78ee8b0bebe3115bb21b732672082925b8bf493f10dffb8a3d5ccd8ccce453395061340626ce17ca26d82cf743";
        // Security council
        expectedDataToSign[2] =
            "0x1901df53d510b56e539b90b369ef08fce3631020fbf921e3136ea5f8747c20bce9671941d118233b743265fac6af569f20f3a3ab6f1e82d11bdfd6804395018919ff";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, currentRootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the GnosisSafeApproveHash template at block 8384642 on sepolia
    /// Simulate from task directory (test/tasks/example/sep/013-gnosis-safe-approve-hash) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate base
    function testRegressionCallDataMatches_GnosisSafeApproveHash() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/013-gnosis-safe-approve-hash/config.toml";
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000fe884546476ddd290ec46318785046ef68a0ba90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024d4d9bdcdffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new GnosisSafeApproveHash();
        address rootSafe = address(0x646132A1667ca7aD00d36616AFBA1A28116C770A);
        address nestedSafe = address(0x6AF0674791925f767060Dd52f7fB20984E8639d8);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, nestedSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8384642, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the GnosisSafeApproveHash template at block 8384642 on sepolia.
        string[] memory expectedDataToSign = new string[](2);
        // Base
        expectedDataToSign[0] =
            "0x19016f25427e79742a1eb82c103e2bf43c85fc59509274ec258ad6ed841c4a0048aa2e27e741e14f9f6dec72970055113c8d1ce16a6501494d60c37b62f6ee5cf93d";
        // Council
        expectedDataToSign[1] =
            "0x19010127bbb910536860a0757a9c0ffcdf9e4452220f566ed83af1f27f9e833f0e230465e4668267169d5177270efb72b5bb67c2c926901e3c6b144b2e1c3c6532f4";

        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the SetDisputeGameImpl template at block 7798424 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/014-set-dispute-game-impl/config.toml) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <foundation|council>
    function testRegressionCallDataMatches_SetDisputeGameImpl() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/014-set-dispute-game-impl/config.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000380000000000000000000000000860e626c700af381133d9f4af31412a2d1db3d5d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004414f6b1a30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000323d727a1a147869cec0c02de1d4195d1b71f2eb00000000000000000000000000000000000000000000000000000000000000000000000000000000860e626c700af381133d9f4af31412a2d1db3d5d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004414f6b1a3000000000000000000000000000000000000000000000000000000000000000100000000000000000000000039228e51a12662d78de478bfa1930fc7595337d800000000000000000000000000000000000000000000000000000000000000000000000000000000860e626c700af381133d9f4af31412a2d1db3d5d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000441e3342400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011c37937e08000000000000000000000000000000000000000000000000000000000000000000000000000000000000860e626c700af381133d9f4af31412a2d1db3d5d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000441e3342400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000011c37937e08000000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new SetDisputeGameImpl();
        address rootSafe = address(0x1Eb2fFc903729a0F03966B917003800b145F56E2);
        address nestedSafe = address(0xDEe57160aAfCF04c34C887B5962D0a69676d3C8B); // sepolia
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, nestedSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 7798424, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        string[] memory expectedDataToSign = new string[](2);
        // Foundation
        expectedDataToSign[0] =
            "0x190137e1f5dd3b92a004a23589b741196c8a214629d4ea3a690ec8e41ae45c689cbb1a9de2fedb15bb0ff64bf46c471a46a6316c63f5869e6569f8f278948ba98215";
        // Security Council
        expectedDataToSign[1] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533ca9a17a70e3907304b76eac257ee383fe711c3d859fa473b991887531152e07b";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the OPCMUpgradeV220toV400 template at block 9068770 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/023-u13-to-u16) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate <foundation|council>
    function testRegressionCallDataMatches_OPCMUpgradeV220toV400() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/023-u13-to-u16/config.toml";
        string memory expectedCallData =
            "0x82ad56cb00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004400000000000000000000000006b6f9129efb1b7a48f84e3b787333d1dca02ee340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4ff2dd5a10000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000015cd4f6e0ce3b4832b33cb9c6f6fe6fc246754c2000000000000000000000000e7413127f29e050df65ac3fc9335f85bb10091ae039facea52b20c605c05efb0a33560a92de7074218998f75bcdf61e8989cb5d900000000000000000000000000000000000000000000000000000000000000000000000000000000fbceed4de885645fbded164910e10f52febfab350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4ff2dd5a10000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000015cd4f6e0ce3b4832b33cb9c6f6fe6fc246754c2000000000000000000000000e7413127f29e050df65ac3fc9335f85bb10091ae03ee2917da962ec266b091f4b62121dc9682bb0db534633707325339f99ee40500000000000000000000000000000000000000000000000000000000000000000000000000000000fbceed4de885645fbded164910e10f52febfab350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a49a72745b0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000015cd4f6e0ce3b4832b33cb9c6f6fe6fc246754c2000000000000000000000000e7413127f29e050df65ac3fc9335f85bb10091ae03682932cec7ce0a3874b19675a6bbc923054a7b321efc7d3835187b172494b6000000000000000000000000000000000000000000000000000000000000000000000000000000001ac76f0833bbfccc732cadcc3ba8a3bbd0e89c3d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4ff2dd5a10000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000015cd4f6e0ce3b4832b33cb9c6f6fe6fc246754c2000000000000000000000000e7413127f29e050df65ac3fc9335f85bb10091ae03eb07101fbdeaf3f04d9fb76526362c1eea2824e4c6e970bdb19675b72e4fc800000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new OPCMUpgradeV220toV400();
        address rootSafe = address(0x1Eb2fFc903729a0F03966B917003800b145F56E2);
        address nestedSafe = address(0xDEe57160aAfCF04c34C887B5962D0a69676d3C8B); // sepolia
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, nestedSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9068770, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        string[] memory expectedDataToSign = new string[](2);
        // Foundation
        expectedDataToSign[0] =
            "0x190137e1f5dd3b92a004a23589b741196c8a214629d4ea3a690ec8e41ae45c689cbbb87ebd854fc92f1b2d587fd83f2d9c6322f08aabd73a389954d77458abe91c3c";
        // Security Council
        expectedDataToSign[1] =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533092c9f45e0c8818668b9d570f66b7a73ba1196a017bc2695c88886e539d3691a";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice expected call data and data to sign generated by manually running the WelcomeToSuperchainOps at block 22884610 on mainnet using script:
    /// forge script test/template/WelcomeToSuperchainOps.sol --sig "simulate(string)" test/tasks/example/eth/011-welcome-to-superchain-ops/config.toml --rpc-url mainnet --fork-block-number 22884610 -vv
    function testRegressionCallDataMatches_WelcomeToSuperchainOps() public {
        address rootSafe = address(0xc2819DC788505Aac350142A7A707BF9D03E3Bd03); // SecurityCouncil
        string memory taskConfigFilePath = "test/tasks/example/eth/011-welcome-to-superchain-ops/config.toml";
        // Calldata generated by manually running the WelcomeToSuperchainOps template at block 21724199 on mainnet.
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000fb11b4164894912f079de62699f4cc5a2271f0c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064c47f0027000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000075361746f7368690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

        MultisigTask multisigTask = new WelcomeToSuperchainOps();

        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 22884610, "mainnet", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // Data to sign generated by manually running the gas config template at block 21724199 on mainnet.
        string memory expectedDataToSign =
            "0x1901df53d510b56e539b90b369ef08fce3631020fbf921e3136ea5f8747c20bce967403a740666390f395a1b6c8e6c4647b4fc82a84c1c46579df5920cd8dd1e8557";
        string memory dataToSign = vm.toString(
            GnosisSafeHashes.getEncodedTransactionData(rootSafe, rootSafeCalldata, 0, rootSafeNonce, MULTICALL3_ADDRESS)
        );
        // assert that the data to sign generated in simulate is the same as the expected data to sign
        assertEq(keccak256(bytes(dataToSign)), keccak256(bytes(expectedDataToSign)));
        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Expected call data and data to sign generated by manually running the GnosisSafeRemoveOwner at block 8764394 on mainnet using script:
    /// forge script GnosisSafeRemoveOwner --sig "simulate(string)" test/tasks/example/sep/016-gnosis-safe-remove-owner/config.toml --rpc-url sepolia --fork-block-number 8764394 -vv
    function testRegressionCallDataMatches_GnosisSafeRemoveOwner() public {
        address rootSafe = address(0xf64bc17485f0B4Ea5F06A96514182FC4cB561977); // SecurityCouncil
        string memory taskConfigFilePath = "test/tasks/example/sep/016-gnosis-safe-remove-owner/config.toml";
        // Calldata generated by manually running the WelcomeToSuperchainOps template at block 21724199 on mainnet.
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000f64bc17485f0b4ea5f06a96514182fc4cb5619770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064f8dc5dd900000000000000000000000000000000000000000000000000000000000000010000000000000000000000001084092ac2f04c866806cf3d4a385afa4f6a6c97000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000";

        MultisigTask multisigTask = new GnosisSafeRemoveOwner();

        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8764394, "sepolia", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        // Data to sign generated by manually running the gas config template at block 8764394 on sepolia.
        string memory expectedDataToSign =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533b3f87e97e0fb7d9d4d4aac3b90da9f4d380c27f9a91e1e883083ced5395e3ab9";
        string memory dataToSign = vm.toString(
            GnosisSafeHashes.getEncodedTransactionData(rootSafe, rootSafeCalldata, 0, rootSafeNonce, MULTICALL3_ADDRESS)
        );
        // assert that the data to sign generated in simulate is the same as the expected data to sign
        assertEq(keccak256(bytes(dataToSign)), keccak256(bytes(expectedDataToSign)));
        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Expected call data and data to sign generated by manually running the SetEIP1967Implementation template at block 8772255 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/018-set-eip1967-impl/config.toml) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/nested.just simulate <test-rehearsal-council|test-rehearsal-foundation>
    function testRegressionCallDataMatches_SetEIP1967Implementation() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/018-set-eip1967-impl/config.toml";
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003f096542fa6f082d09748eb43cb2fb4394e211a1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000a88d1b67dee50d0f1465868628a145fe828694f70000000000000000000000002d7e764a0d9919e16983a46595cfa81fc34fa7cd00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new SetEIP1967Implementation();
        address rootSafe = address(0x22A8dA5cC81B0e8FbcD80bf5632fC37748AA54B9); // Fake Rehearsal L1ProxyAdminOwner
        address nestedSafe = address(0xa05269513e77a322Da08ca426f8F49100b033303); // Fake Rehearsal SecurityCouncil
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, nestedSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8772255, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        string[] memory expectedDataToSign = new string[](2);
        // Foundation
        expectedDataToSign[0] =
            "0x1901941a0a47624c2804b10868bc413d50f87fef63bcc73aa69b47eb2f78d9f96eabc6eba853efcf7498489671d5ab8a3d68ad6a41d91e4720feac6b4eb5bf40fe64";
        // Security Council
        expectedDataToSign[1] =
            "0x1901f9191d330010bd7cb341b53e974f501dfeeb2ecab306ab589e62ba5988abb193c6eba853efcf7498489671d5ab8a3d68ad6a41d91e4720feac6b4eb5bf40fe64";
        _assertDataToSignNestedMultisig(multisigTask, actions, expectedDataToSign, MULTICALL3_ADDRESS, rootSafe);
    }

    /// @notice Expected call data and data to sign generated by manually running the UniFix template at block 8029861 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/004-replace-superchain-config/config.toml) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path "$(pwd)"/.env --justfile ../../../../../src/improvements/justfile simulate
    function testRegressionCallDataMatches_UniFix() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/004-replace-superchain-config/config.toml";
        string memory expectedCallData =
            "0x174dea710000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001500000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000007a000000000000000000000000000000000000000000000000000000000000008a000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000ba00000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000000000000000000000000000000000000000000da00000000000000000000000000000000000000000000000000000000000000ea00000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000010a000000000000000000000000000000000000000000000000000000000000011a000000000000000000000000000000000000000000000000000000000000012a000000000000000000000000000000000000000000000000000000000000013a000000000000000000000000000000000000000000000000000000000000014a000000000000000000000000000000000000000000000000000000000000015a000000000000000000000000000000000000000000000000000000000000016a00000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000448a37330a60494e666f6dd60ad48d930aeba381000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc00000000000000000000000000000000000000000000000000000000000000000000000000000000448a37330a60494e666f6dd60ad48d930aeba38100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db0800000000000000000000000000000000000000000000000000000000000000fb000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000448a37330a60494e666f6dd60ad48d930aeba381000000000000000000000000d3494713a5cfad3f5359379dfa074e2ac8c6fd65000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000004696b5e042755103fe558738bcd1ecee7a45ebfe000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc000000000000000000000000000000000000000000000000000000000000000000000000000000004696b5e042755103fe558738bcd1ecee7a45ebfe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db080000000000000000000000000000000000000000000000000000000000000032000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000004696b5e042755103fe558738bcd1ecee7a45ebfe000000000000000000000000ae2af01232a6c4a4d3012c5ec5b1b35059caf10d000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000ea58fca6849d79ead1f26608855c2d6407d54ce2000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc00000000000000000000000000000000000000000000000000000000000000000000000000000000ea58fca6849d79ead1f26608855c2d6407d54ce200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db080000000000000000000000000000000000000000000000000000000000000032000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000ea58fca6849d79ead1f26608855c2d6407d54ce200000000000000000000000064b5a5ed26dcb17370ff4d33a8d503f0fbd06cff000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000f971f1b0d80eb769577135b490b913825bfcf00b000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc00000000000000000000000000000000000000000000000000000000000000000000000000000000f971f1b0d80eb769577135b490b913825bfcf00b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db080000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec4000000000000000000000000f971f1b0d80eb769577135b490b913825bfcf00b000000000000000000000000cc9ecb6a9b83c333af2bf666158bd0eef73c7858000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec400000000000000000000000073d18d6caa14aeec15449d0a25a31d4e7e097a5c000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc0000000000000000000000000000000000000000000000000000000000000000000000000000000073d18d6caa14aeec15449d0a25a31d4e7e097a5c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db080000000000000000000000000000000000000000000000000000000000000068000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec400000000000000000000000073d18d6caa14aeec15449d0a25a31d4e7e097a5c00000000000000000000000007f69b19532476c6cd03056d6bc3f1b110ab7538000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000004e7e6dc46ce003a1e353b6848bf5a4fc1feac8ae000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc000000000000000000000000000000000000000000000000000000000000000000000000000000004e7e6dc46ce003a1e353b6848bf5a4fc1feac8ae00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db080000000000000000000000000000000000000000000000000000000000000068000000000000000000000000c2be75506d5724086deb7245bd260cc9753911be000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000004e7e6dc46ce003a1e353b6848bf5a4fc1feac8ae00000000000000000000000007f69b19532476c6cd03056d6bc3f1b110ab7538000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000000d83dab629f0e0f9d36c0cbc89b69a489f0751bd000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc000000000000000000000000000000000000000000000000000000000000000000000000000000000d83dab629f0e0f9d36c0cbc89b69a489f0751bd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000444e91db0800000000000000000000000000000000000000000000000000000000000000350000000000000000000000c2be75506d5724086deb7245bd260cc9753911be00000000000000000000000000000000000000000000000000000000000000000000000000000000002bf403e5353a7a082ef6bb3ae2be3b866d8d3ea4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000000d83dab629f0e0f9d36c0cbc89b69a489f0751bd00000000000000000000000035028bae87d71cbc192d545d38f960ba30b4b23300000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new UniFix();
        address rootSafe = address(0xd363339eE47775888Df411A163c586a8BdEA9dbf); // Fake Rehearsal L1ProxyAdminOwner
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);
        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8029861, "sepolia", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        string memory expectedDataToSign =
            "0x19012fedecce87979400ff00d5cec4c77da942d43ab3b9db4a5ffc51bb2ef498f30bbd1fd892d80773da28cae7662bb39eef7c5783d531bfa9c596ee8f578a170b02";
        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }
    /// @notice Expected call data generated by manually running the DeputyPauseKeyRotationTemplate at block 8092613 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/007-deputy-pause-key-rotation/config.toml) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path "$(pwd)"/.env --justfile ../../../../../src/improvements/justfile simulate

    function testRegressionCallDataMatches_DeputyPauseKeyRotationTemplate() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/007-deputy-pause-key-rotation/config.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c6f7c07047ba37116a3fdc444afb5018f6df575800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c4183b708b0000000000000000000000006a07d585eddba8f9a4e17587f4ea5378de1c3bac000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000413efc7828dc57f2137dbca8cfe74deb05a707ef8b0f62d4c67321dda5ac09c5ee7597bf41708c4cefbae0697a8455165ef7c61fc1ebcf23dad72669253723b3da1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new DeputyPauseKeyRotationTemplate();
        address rootSafe = address(0x837DE453AD5F21E89771e3c06239d8236c0EFd5E); // FoundationOperationsSafe
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 8092613, "sepolia", multisigTask, allSafes);

        bytes memory rootSafeCalldata =
            _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];

        string memory expectedDataToSign =
            "0x1901e84ad8db37faa1651b140c17c70e4c48eaa47a635e0db097ddf4ce1cc14b9ecbfc232e99f109db09a90ec0a319406d8e3df078659b05aeac83b22bdc64a18801";
        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Internal function to set up the fork and run the simulate method
    function _setupAndSimulate(
        string memory taskConfigFilePath,
        uint256 blockNumber,
        string memory network,
        MultisigTask multisigTask,
        address[] memory allSafes
    ) internal returns (Action[] memory actions, uint256[] memory allOriginalNonces) {
        vm.createSelectFork(network, blockNumber);
        if (allSafes.length > 1) {
            // TODO: fix when we support > 1 level of nesting.
            address childSafe = allSafes[0];
            allOriginalNonces = MultisigTaskTestHelper.getAllOriginalNonces(allSafes);
            (, actions,,,) = multisigTask.simulate(taskConfigFilePath, Solarray.addresses(childSafe));
        } else {
            allOriginalNonces = MultisigTaskTestHelper.getAllOriginalNonces(allSafes);
            (, actions,,,) = multisigTask.simulate(taskConfigFilePath, new address[](0));
        }
    }

    /// @notice Assert that the call data generated by the multisig task matches the expected call data.
    function _assertCallDataMatches(
        MultisigTask multisigTask,
        Action[] memory actions,
        address[] memory allSafes,
        uint256[] memory allOriginalNonces,
        string memory expectedCallData
    ) internal view returns (bytes memory rootSafeCalldata) {
        bytes[] memory allCalldatas = multisigTask.transactionDatas(actions, allSafes, allOriginalNonces);
        rootSafeCalldata = allCalldatas[allCalldatas.length - 1];
        assertEq(keccak256(bytes(vm.toString(rootSafeCalldata))), keccak256(bytes(expectedCallData)));
    }

    /// @notice assert that the data to sign generated by the single multisig task matches the expected data to sign
    function _assertDataToSignSingleMultisig(
        address rootSafe,
        bytes memory rootSafeCalldata,
        string memory expectedDataToSign,
        uint256 originalNonce,
        address multicallAddress
    ) internal view {
        string memory dataToSign = vm.toString(
            GnosisSafeHashes.getEncodedTransactionData(rootSafe, rootSafeCalldata, 0, originalNonce, multicallAddress)
        );
        assertEq(keccak256(bytes(dataToSign)), keccak256(bytes(expectedDataToSign)));
    }

    /// @notice assert that the data to sign generated by the nested multisig task matches the expected data to sign
    /// for each child multisig
    function _assertDataToSignNestedMultisig(
        MultisigTask multisigTask,
        Action[] memory actions,
        string[] memory expectedDataToSign,
        address multicallAddress,
        address rootSafe
    ) internal {
        address[] memory owners = IGnosisSafe(rootSafe).getOwners();
        // Decrement the root safe by 1.
        MultisigTaskTestHelper.decrementNonceAfterSimulation(rootSafe);
        for (uint256 i = 0; i < owners.length; i++) {
            // Decrement the nonces by 1 because in the task simulation, child multisig nonces are incremented.
            MultisigTaskTestHelper.decrementNonceAfterSimulation(owners[i]);
            address[] memory tmpAllSafes = MultisigTaskTestHelper.getAllSafes(rootSafe, owners[i]);
            uint256[] memory tmpAllOriginalNonces = MultisigTaskTestHelper.getAllOriginalNonces(tmpAllSafes);
            bytes memory childSafeCalldata =
                multisigTask.transactionDatas(actions, tmpAllSafes, tmpAllOriginalNonces)[0];
            uint256 childSafeNonce = tmpAllOriginalNonces[0];
            string memory dataToSign = vm.toString(
                GnosisSafeHashes.getEncodedTransactionData(
                    owners[i], childSafeCalldata, 0, childSafeNonce, multicallAddress
                )
            );
            assertEq(keccak256(bytes(dataToSign)), keccak256(bytes(expectedDataToSign[i])));
        }
    }

    /// @notice Expected call data and data to sign generated by manually running the EnableLivenessModule2 template at block 9120411 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/024-enable-liveness-module2) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate
    function testRegressionCallDataMatches_EnableLivenessModule2() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/024-enable-liveness-module2/config.toml";
        string memory expectedCallData =
            "0x174dea7100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000007a50f00e8d05b95f98fe38d8bee366a7324dcf7e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024610b5925000000000000000000000000bf83ace11fa979b90c1e914cc5565271f22c661500000000000000000000000000000000000000000000000000000000000000000000000000000000bf83ace11fa979b90c1e914cc5565271f22c66150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044a24417750000000000000000000000000000000000000000000000000000000000278d00000000000000000000000000dee57160aafcf04c34c887b5962d0a69676d3c8b00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new EnableLivenessModule2();
        address rootSafe = address(0xf64bc17485f0B4Ea5F06A96514182FC4cB561977);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9120411, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the EnableLivenessModule2 template at block 9120411 on sepolia
        bytes memory rootSafeCalldata =
            multisigTask.transactionDatas(actions, allSafes, allOriginalNonces)[allSafes.length - 1];
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];
        string memory expectedDataToSign =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b85335fd8239f6409ff29a2c178f9c26e3a1096bfb98bb1bb608d9c6ddd2baa40cdc5";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Expected call data and data to sign generated by manually running the DisableLivenessModule2 template at block 9120411 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/025-disable-liveness-module2) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate
    function testRegressionCallDataMatches_DisableLivenessModule2() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/025-disable-liveness-module2/config.toml";
        string memory expectedCallData =
            "0x174dea7100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000007a50f00e8d05b95f98fe38d8bee366a7324dcf7e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044e009cfde0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000bf83ace11fa979b90c1e914cc5565271f22c661500000000000000000000000000000000000000000000000000000000000000000000000000000000bf83ace11fa979b90c1e914cc5565271f22c6615000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000452efea6e00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new DisableLivenessModule2();
        address rootSafe = address(0xf64bc17485f0B4Ea5F06A96514182FC4cB561977);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9120411, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the DisableLivenessModule2 template at block 9120411 on sepolia
        bytes memory rootSafeCalldata =
            multisigTask.transactionDatas(actions, allSafes, allOriginalNonces)[allSafes.length - 1];
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];
        string memory expectedDataToSign =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533c1e190e3922958637cf700f54f791ee35dc37ea3ef726da3341a6f1af678a7c9";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }

    /// @notice Expected call data and data to sign generated by manually running the TransitionToLivenessModule2 template at block 9120411 on sepolia.
    /// Simulate from task directory (test/tasks/example/sep/026-transition-to-liveness-module2) with:
    /// SIMULATE_WITHOUT_LEDGER=1 just --dotenv-path $(pwd)/.env --justfile ../../../../../src/improvements/justfile simulate
    function testRegressionCallDataMatches_TransitionToLivenessModule2() public {
        string memory taskConfigFilePath = "test/tasks/example/sep/026-transition-to-liveness-module2/config.toml";
        string memory expectedCallData =
            "0x174dea71000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000340000000000000000000000000f64bc17485f0b4ea5f06a96514182fc4cb5619770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044e009cfde0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000eb3ef34acf1a6c1630807495bcc07ed3e7b0177e00000000000000000000000000000000000000000000000000000000000000000000000000000000f64bc17485f0b4ea5f06a96514182fc4cb5619770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024e19a9dd9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f64bc17485f0b4ea5f06a96514182fc4cb5619770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024610b5925000000000000000000000000bf83ace11fa979b90c1e914cc5565271f22c661500000000000000000000000000000000000000000000000000000000000000000000000000000000bf83ace11fa979b90c1e914cc5565271f22c66150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044a24417750000000000000000000000000000000000000000000000000000000000278d00000000000000000000000000dee57160aafcf04c34c887b5962d0a69676d3c8b00000000000000000000000000000000000000000000000000000000";
        MultisigTask multisigTask = new TransitionToLivenessModule2();
        address rootSafe = address(0xf64bc17485f0B4Ea5F06A96514182FC4cB561977);
        address[] memory allSafes = MultisigTaskTestHelper.getAllSafes(rootSafe);

        (Action[] memory actions, uint256[] memory allOriginalNonces) =
            _setupAndSimulate(taskConfigFilePath, 9120411, "sepolia", multisigTask, allSafes);

        _assertCallDataMatches(multisigTask, actions, allSafes, allOriginalNonces, expectedCallData);

        // Data to sign generated by manually running the TransitionToLivenessModule2 template at block 9120411 on sepolia
        bytes memory rootSafeCalldata =
            multisigTask.transactionDatas(actions, allSafes, allOriginalNonces)[allSafes.length - 1];
        uint256 rootSafeNonce = allOriginalNonces[allOriginalNonces.length - 1];
        string memory expectedDataToSign =
            "0x1901be081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b853325f232af09418868033d8c0c6b60300a975a662de140a678fa54bd481391c52a";

        _assertDataToSignSingleMultisig(
            rootSafe, rootSafeCalldata, expectedDataToSign, rootSafeNonce, MULTICALL3_ADDRESS
        );
    }
}
